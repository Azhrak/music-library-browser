---
import Layout from '../../components/astro/Layout.astro';
import Breadcrumb from '../../components/astro/Breadcrumb.astro';
import AlbumSection from '../../components/astro/AlbumSection.astro';
import CountryFlag from '../../components/astro/CountryFlag.astro';
import ExternalLinks from '../../components/astro/ExternalLinks.astro';
import { getAllArtists } from '../../lib/musicData';
import { getSpotifyArtistUrl } from '../../lib/spotify';
import { slugify } from '../../lib/slugify';
import { albumTypeSections } from '../../lib/albumTypeStyles';

export function getStaticPaths() {
  const artists = getAllArtists();

  return artists.map((artist) => ({
    params: { slug: artist.slug },
    props: { artist },
  }));
}

const { artist } = Astro.props;
const spotifyDirectUrl = getSpotifyArtistUrl(artist.slug);

const genreHref = `/genre/${artist.genrePath.map((p) => slugify(p)).join('/')}`;
const genreLabel = artist.genrePath.join(' > ');

const breadcrumb = [
  { label: artist.genrePath[0], href: `/genre/${slugify(artist.genrePath[0])}` },
  ...(artist.genrePath.length > 1
    ? [{ label: genreLabel, href: genreHref }]
    : []),
  { label: artist.name },
];

const albums = artist.albums;
---

<Layout title={artist.name}>
  <Breadcrumb items={breadcrumb} />

  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-100">{artist.name}</h1>
    <div class="mt-2 flex flex-wrap items-center gap-3 text-gray-400">
      {artist.country && (
        <span class="inline-flex items-center gap-2">
          <CountryFlag isoCodes={artist.isoCodes} country={artist.country} size={20} />
          {artist.country}
        </span>
      )}
      {artist.tags.length > 0 && (
        <span class="text-sm text-gray-500">({artist.tags.join(', ')})</span>
      )}
      <a href={genreHref} class="text-sm text-accent-light hover:underline">
        {genreLabel}
      </a>
    </div>
    <div class="mt-2">
      <ExternalLinks artistName={artist.name} spotifyDirectUrl={spotifyDirectUrl} />
    </div>
    <p class="mt-1 text-sm text-gray-500">
      {albums.length} {albums.length === 1 ? 'release' : 'releases'}
      {albums[0]?.year && albums[albums.length - 1]?.year && (
        <span>
          &middot; {albums[0].year}&ndash;{albums[albums.length - 1].year}
        </span>
      )}
    </p>
  </div>

  {albumTypeSections.map((type) => {
    const filtered = albums.filter((a) => a.type === type);
    return <AlbumSection albums={filtered} type={type} artistSlug={artist.slug} />;
  })}
</Layout>
