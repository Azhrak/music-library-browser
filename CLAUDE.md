# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
pnpm dev              # Parse data + start dev server
pnpm build            # Parse data + build static site (~3s, ~13k pages)
pnpm typecheck        # Astro type checking (strict mode)
pnpm check            # Biome lint + format (auto-fix)
pnpm format           # Biome format only
pnpm lint             # Biome lint only

# Data pipeline (run separately, not part of build)
pnpm parse            # folderHierarchy.json → musicData.json + searchIndex.json
pnpm art              # Extract album art from music library → public/album-art/*.webp
pnpm spotify          # Fetch Spotify artist IDs/URLs → spotifyArtistManifest.json
pnpm spotify-albums   # Fetch album tracks + art → spotifyAlbumManifest.json
pnpm spotify-albums --limit=10  # Test with small subset
pnpm cf-deploy        # Build + deploy to Cloudflare Pages
```

## Architecture

Astro 5 static site with React islands for search. Tailwind CSS v4 (configured via `@theme` in `src/styles/global.css`, no tailwind.config file). Biome for linting/formatting (2-space indent, 100 char lines).

### Data Pipeline

```
data/folderHierarchy.json (folder names only, generated by scripts/folder-hierarchy-generator.py)
    │
    ├─ scripts/generateMusicData.ts (parser with multi-signal heuristics)
    │   ├─ data/generated/musicData.json (structured library: genres → subgenres → artists → albums)
    │   └─ public/searchIndex.json (flattened for Fuse.js client-side search)
    │
    ├─ scripts/processAlbumArt.ts (reads images from MUSIC_LIBRARY_ROOT)
    │   ├─ public/album-art/{artistSlug}/{albumSlug}.webp (500px, WebP 80%)
    │   └─ data/generated/albumArtManifest.json
    │
    ├─ scripts/spotify/fetchSpotifyArtists.ts (artist name → Spotify ID)
    │   └─ data/generated/spotifyArtistManifest.json (2825/3099 matched)
    │
    └─ scripts/spotify/fetchSpotifyAlbums.ts (album matching + track fetching + art download)
        └─ data/generated/spotifyAlbumManifest.json (tracks, durations, Spotify URLs, images)
```

All `data/generated/` and `public/album-art/` are gitignored. The Spotify scripts support incremental updates and checkpointing.

### Parser Heuristics (generateMusicData.ts)

The parser classifies folders using multiple signals:
- **Artists**: detected by country code suffix `(Ger)`, `(UK)`, `(Aut-UK)`, or by children having `[YYYY]` albums
- **Albums**: `[YYYY] Album Name` pattern, with type detection (EP, Single, Demo, Live, Split)
- **VA compilations**: `- VA -` prefix
- **Ignored genres**: Downloads, Various, Classical, No Copyright
- **Country codes**: 71 custom mappings in `scripts/countryMapping.ts`, 85+ false positives excluded
- **Tags**: `(early)`, `(later)`, `(acoustic)`, `(instrumental)` parsed after country code
- **Reissues**: `[YYYY reissue]`, `[YYYY remaster]` patterns
- **Multi-disc**: `CD1`/`CD2`/`Disc N` subfolders

### Routing

- `/` — homepage with genre cards
- `/genre/[...path]` — catch-all for genres and nested subgenres
- `/artist/[slug]` — artist page with album grid
- `/artist/[artistSlug]/[albumSlug]` — album page with tracklist

All pages use `getStaticPaths()` for SSG. Data access via `src/lib/musicData.ts` helpers.

### Key Patterns

- **Manifest pattern**: Build-time scripts produce JSON manifests in `data/generated/`. Runtime helpers in `src/lib/` import them with try/catch fallback (graceful when manifest doesn't exist yet).
- **Spotify scripts**: Live under `scripts/spotify/`. Shared auth, rate limiting (5 concurrent, 200ms delay), retry with backoff, and `.env` loading in `spotifyAuth.ts`.
- **Slugify**: `src/lib/slugify.ts` generates URL-safe slugs with uniqueness tracking. Used everywhere for routing.
- **Album art**: `AlbumArtImage.astro` shows art if manifest entry exists, placeholder `ImageOff` icon otherwise.

### Environment Variables

```
MUSIC_LIBRARY_ROOT=F:\MP3          # For album art processing
SPOTIFY_CLIENT_ID=                  # For Spotify API scripts
SPOTIFY_CLIENT_SECRET=
```

## TypeScript

- Path aliases: `@components/*`, `@lib/*`, `@data/*`
- Strict mode via `astro/tsconfigs/strict`
- Shared types in `scripts/types.ts` (Genre, Subgenre, Artist, Album, ReleaseType)
- Spotify types in `src/lib/spotifyTypes.ts`
- ESM-only (`"type": "module"`)
